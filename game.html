<!DOCTYPE html>
<html>
	
	<head>
		<meta charset="UTF-8">
		<title>Sprite</title>
	</head>
	
	<body>
		<div style = "text-align:center;">
			<canvas id="myCanvas" width="1500" height="666">
				Your browser does not support HTML5 Canvas.
			</canvas>
		</div>
	<script>
		const canvas = document.querySelector('#myCanvas');
		const ctx = canvas.getContext("2d");
		
		const W = canvas.width, H = canvas.height;
		
		let bg = new Image();
		bg.src = 'images/background.png'

		let image = new Image();
		image.src = 'images/kitty.png';
		let ecopontos = new Image();
		ecopontos.src = 'images/ecopontos.png';

		let Trashes = new Array();

		let inventory = new Image();
		inventory.src = 'images/inventory.png';

		let milk = new Image();
		milk.src = 'trash/milk_gallon.png';

		let light = new Image();
		light.src = 'trash/light_bulb.png'
		

		//sprite frame counter 		
		let frameCol = 0;
		let frameRow = 0;

		let frameG = frameB = frameY = 0
		
		let x = canvas.width / 2.13;
		let y = canvas.height / 2.13;
		let sizex = 192/4;
		let sizey = 192/4;
		
		let rightKey = false; //only for Canvas#2
		let leftKey = false;
		let upKey = false;
		let downKey = false;
		let gKey = false;
		let pKey = false
		
		let positions = [
			{
				x:638,
				y:589,
				full:false,
			},
			{
				x:688,
				y:589,
				full:false,
			},
			{
				x:736,
				y:589,
				full:false,
			},
			{
				x:785,
				y:589,
				full:false,
			},
			{
				x:832,
				y:589,
				full:false,
			},
		]
		
		// ------------------------------

		const lixos=[['candy_bar','yellow'],['glue_stick','yellow'],['rubber_duck','yellow'], ['snack1','yellow'], ['snack2','yellow'], ['spatula','yellow'],['paper_bag','blue'],['receipt','blue'], ['toilet_paper','blue']]
		
		// let yellow = ['candy_bar','glue_stick','rubber_duck', 'snack1', 'snack2', 'spatula']

		// let green = []

		// let blue = ['paper_bag','receipt', 'toilet_paper']

		class Trash {
			constructor(src, x, y,trash) {    // CONSTRUCTOR
				this.src = src;
				this.x = x;
				this.y = y;
				this.trash=''
				this.place=0
				this.inventory = false;
				this.start = false;
			}
			draw() {
				console.log('drawing')
			}
		}

		function init() {
			//setup trash in random places(within the specific space in the map)
			for (let i = 0; i < 9; i++) {
				let num = Math.floor(Math.random()*(lixos.length))
				let src = lixos[num][0]
				let trashh=lixos[num][1]
				
				// let src2 = green[Math.floor(Math.random()*(green.length))]
				// let src3 = blue[Math.floor(Math.random()*(blue.length))]
				src = `trash/${src}.png`
				let xInit = 50 + Math.random() * (canvas.width - 50);
				let yInit = 50 + Math.random() * (canvas.height - 200);
				
				// push new object into array
				Trashes.push(new Trash(src, xInit, yInit,trashh))
			}
		}
		
		function grab(x,y){
			Trashes.forEach(trash =>{
				if(trash.x>=x && trash.x<=x+192/2 && trash.y>=y && trash.y<=y+192/2){
					let newPos=positions.find(position => position.full==false)
					trash.x=newPos.x
					trash.y=newPos.y
					trash.inventory=true
					let i=positions.indexOf(newPos)
					trash.place=positions[i]+1
					positions[i].full=true
				}
			})
		}
		
		//load inventory and trash items onto the canvas
		function renderTrash(){
			ctx.drawImage(inventory,0,0,192,64,W/2-(192*1.8)/2,H-120,192*1.8,64*1.8)
			Trashes.forEach(trash =>{
				let img = new Image();
				img.src = trash.src
				ctx.beginPath();
				ctx.rect(trash.x, trash.y, trash.width, trash.height);
				ctx.drawImage(img, trash.x, trash.y, 30, 30);
			})
		}

		function isIntersect(pos,trash){
            return trash.x<pos.x && pos.x<trash.x+30 && trash.y<pos.y && pos.y<trash.y+30
        }

		dragDrop()

		function dragDrop(){
			canvas.addEventListener('mousemove', e => {
				const pos={
					x: e.clientX,
					y: e.clientY
				};

				Trashes.forEach(trash=>{
					console.log(1)
					if(isIntersect(pos, trash)){
						console.log(2)
						if(trash.inventory==true){
							let oldX=trash.x;
							let oldY=trash.y;
							console.log(3)
							canvas.addEventListener('mousedown', e => {
								console.log(4)
								let x1 = e.offsetX; y1 = e.offsetY;
								trash.x=x1;
								trash.y=y1;
								trash.start = true;  
								console.log(trash.inventory)
								console.log(trash.start)
							});
							
							canvas.addEventListener('mousemove', e => {
								let x1 = e.offsetX; y1 = e.offsetY;
				
								if (trash.start) {    //only draw if user has pressed down the mouse button
									trash.x=x1;
									trash.y=y1;
								}
							});
							
							canvas.addEventListener('mouseup', e => {
								trash.x=oldX;
								trash.y=oldY;
								trash.start = false;
								trash.inventory = false;
								positions[trash.place-1].full=false;
								console.log(trash.x, trash.y);
								console.log(oldX)
							});
						}
					}
				})
			})
			


		}

		
		
		//handler for keydown
		function ArrowPressed(e) {
			e.preventDefault();
			if (e.key == 'ArrowRight') {
				rightKey = true; //Canvas#2
			}
			else if (e.key == 'ArrowLeft'){
				leftKey = true; //Canvas#
			}
			else if (e.key == 'ArrowUp') {
				upKey = true; //Canvas#2
			}
			else if (e.key == 'ArrowDown'){
				downKey = true; //Canvas#
			}
			else if(e.keyCode==71){
				gKey = true;
			}
			else if(e.keyCode==80){
				
				sizex = 96/2
				sizey = 576/12
				if (!pKey)
				image.src = 'images/actions.png'
				pKey = true;
			}
		}

		//handler for keyup
		function ArrowReleased(e) {
			if (e.key == 'ArrowRight'){
				rightKey = false;
				frameCol = 0;
			}
			else if (e.key == 'ArrowLeft'){
				leftKey = false;
				frameCol = 0;
			}
			else if (e.key == 'ArrowUp'){
				upKey = false;
				frameCol = 0;
			}
			else if (e.key == 'ArrowDown'){
				downKey = false;
				frameCol = 0;
			}
			else if (e.keyCode == 71){
				gKey = false;
				frameCol = 0;
			}
		}
		
		//sets handlers for events keydown & keyup
		window.addEventListener('keydown', ArrowPressed);
		window.addEventListener('keyup', ArrowReleased);
		
		//--------------------------------

		canvas.addEventListener("mousemove", function(e) { 
		    var cRect = canvas.getBoundingClientRect();        // Gets CSS pos, and width/height
		    var canvasX = Math.round(e.clientX - cRect.left);  // Subtract the 'left' of the canvas 
		    var canvasY = Math.round(e.clientY - cRect.top);   // from the X/Y positions to make  
		    console.log("X: "+canvasX+", Y: "+canvasY);
		});


		//--------------------------------

		ecopontos.onload = function () {
			canvas.addEventListener('mousemove', e =>{
				frameG++;
				if (frameG == 5)
				frameG = 0;
			})
			};

		function render() {
			ctx.clearRect(0, 0, canvas.width, canvas.height);
			if (rightKey && x < canvas.width - 100){
				frameRow = 3;
				x+=10;
				frameCol++;	
				if (frameCol == 4)
				frameCol = 2;
			}
			else if (leftKey && x > 100){
				x-=10;
				frameRow = 2;
				frameCol++;	
				if (frameCol == 4)
				frameCol = 0;
			}
			else if (upKey && y > 50){
				y-=10;
				frameRow = 1;
				frameCol++;	
				if (frameCol == 4)
				frameCol = 0;
			}
			else if (downKey && y < canvas.height - 170){
				y+=10;
				frameRow = 0;
				frameCol++;	
				if (frameCol == 4)
				frameCol = 0;
			}
			else if (gKey){
				frameCol++;	
				if (frameCol == 2)
					frameCol = 0;
				grab(x,y)
				}
				else if (pKey){
					if (frameRow < 8){
						frameRow += 8
						frameCol = 2
					}
					frameCol--;	
					if (frameCol == -1){
						pKey = false;
						image.src = 'images/kitty.png'
						frameCol = 0;
						sizex = 192/4
						sizey = 192/4
						frameRow -= 8
					}
					
				}
				ctx.drawImage(bg, 0,0, canvas.width, canvas.height)

				border();

				ctx.drawImage(image, frameCol * sizex, frameRow * sizey, sizex, sizey, x, y, 192/2,192/2);
				ctx.drawImage(ecopontos, frameG *240/5, 0, 240/5, 144/3, 0, 200, 2*240/5, 2*144/3)
				ctx.drawImage(ecopontos, frameB *240/5, 144/3, 240/5, 144/3, 50, 200, 2*240/5, 2*144/3)
				ctx.drawImage(ecopontos, frameY *240/5, 2*144/3.05, 240/5, 144/3, 100, 200, 2*240/5, 2*144/3)

				renderTrash();	
			}
			
			function border(){
				// border mapa esquerda
				ctx.strokeStyle = "purple";
				ctx.beginPath();
				
				ctx.moveTo(445, 170);
				ctx.lineTo(445, 180);
				ctx.lineTo(410, 180);
				ctx.lineTo(410, 170);
				ctx.lineTo(445, 170);
				ctx.lineTo(445, 80);
				
				ctx.lineTo(520, 80);
				ctx.lineTo(520, 95);
				ctx.lineTo(615, 95);
				ctx.lineTo(615, 180);
				ctx.lineTo(770, 180);
				ctx.lineTo(770, 320);
				ctx.lineTo(745, 320);
				ctx.lineTo(745, 360);
				ctx.lineTo(850, 360);
				ctx.lineTo(850, 350);
				ctx.lineTo(915, 350);
				ctx.lineTo(915, 195);
				ctx.lineTo(950, 195);
				ctx.lineTo(950, 150);
				ctx.lineTo(990, 150);
				ctx.lineTo(990, 95);
				ctx.lineTo(1020, 95);
				ctx.lineTo(1020, 280);
				ctx.lineTo(1155, 280);
				ctx.lineTo(1155, 260);
				ctx.lineTo(1025, 260);
				ctx.lineTo(1025, 95);
				ctx.lineTo(1075, 95);
				ctx.lineTo(1075, 215);
				ctx.lineTo(1150, 215);
				ctx.lineTo(1150, 190);
				ctx.lineTo(1085, 190);
				ctx.lineTo(1085, 120);
				ctx.lineTo(1245, 120);
				ctx.lineTo(1245, 190);
				ctx.lineTo(1175, 190);
				ctx.lineTo(1175, 215);
				ctx.lineTo(1255, 215);
				ctx.lineTo(1255, 95);
				ctx.lineTo(1285, 95);
				ctx.lineTo(1285, 150);
				ctx.lineTo(1335, 150);
				ctx.lineTo(1335, 260);
				ctx.lineTo(1205, 260);
				ctx.lineTo(1205, 280);
				ctx.lineTo(1340, 280);
				ctx.lineTo(1340, 145);
				ctx.lineTo(1385, 145);
				ctx.lineTo(1385, 160);
				ctx.lineTo(1415, 160);
				ctx.lineTo(1415, 290);
				ctx.lineTo(1445, 290);
				ctx.lineTo(1445, 420);
				ctx.lineTo(1415, 420);
				ctx.lineTo(1415, 510);
				ctx.lineTo(1385, 510);
				ctx.lineTo(1345, 510);
				ctx.lineTo(1345, 540);
				ctx.lineTo(1310, 540);
				ctx.lineTo(1310, 535);
				ctx.lineTo(1275, 535);
				ctx.lineTo(1275, 565);
				ctx.lineTo(1240, 565);
				ctx.lineTo(1240, 605);

				// a partir da ponte
				ctx.moveTo(850, 477);
				ctx.lineTo(850, 410);
				ctx.lineTo(750, 410);
				ctx.lineTo(750, 450);
				ctx.lineTo(650, 450);
				ctx.lineTo(650, 510);
				ctx.lineTo(620, 510);
				ctx.lineTo(620, 433);
				ctx.lineTo(495, 433);
				ctx.lineTo(495, 492);
				ctx.lineTo(600, 492);
				ctx.lineTo(600, 492);
				ctx.lineTo(600, 540);
				ctx.lineTo(478, 543);
				ctx.lineTo(478, 572);
				ctx.lineTo(360, 572);
				ctx.lineTo(360, 600);
				ctx.lineTo(180, 600);
				ctx.lineTo(180, 545);
				ctx.lineTo(160, 545);
				ctx.lineTo(160, 480);
				ctx.lineTo(120, 480);
				ctx.lineTo(120, 450);
				ctx.lineTo(88, 450);
				ctx.lineTo(88, 158);
				ctx.lineTo(115, 158);
				ctx.lineTo(115, 130);
				ctx.lineTo(177, 130);
				ctx.lineTo(177, 55);
				ctx.lineTo(445, 55);
				ctx.lineTo(445, 80);
				ctx.moveTo(230, 55);
				ctx.lineTo(230, 170);
				ctx.lineTo(355, 170);
				ctx.lineTo(355, 180);
				ctx.lineTo(230, 180);
				ctx.lineTo(230, 170);

				// ctx.closePath();
				ctx.stroke();
			}

			window.onload = function () {
				init();
				// actionBins();
				// setInterval(actionBins, 1000 /10)
				setInterval(render, 1000 / 10);
			};

			
	</script>
</body>

</html>